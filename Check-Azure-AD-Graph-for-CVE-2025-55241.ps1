# =====================================================================
# Script : Check-Azure-AD-Graph-for-CVE-2025-55241.ps1
#
# Objectives: 
#        1 - Identify if Azure AD Graph (graph.windows.net) is still in use
#        2 - Output is store in the AADGraphDependencies.csv file
#        3 - Look for recent attempts in logs
#
# =====================================================================

Import-Module Microsoft.Graph

# Connect to MS Graph with required privs (Application.Read.All, AuditLog.Read.All, Directory.Read.All)
Connect-MgGraph -Scopes "Application.Read.All","AuditLog.Read.All","Directory.Read.All"
Select-MgProfile -Name beta

Write-Output "Connected to tenant: $((Get-MgContext).TenantId)"

# Check Apps:
$aadGraphApps = Get-MgServicePrincipal -All | Where-Object {
    $_.ServicePrincipalNames -match "graph.windows.net"
}

if ($aadGraphApps) {
    Write-Output "Azure AD Graph dependencies detected in the following applications:"
    $aadGraphApps | Select-Object DisplayName, AppId, ServicePrincipalNames | Format-Table -AutoSize

    # CSV export
    $aadGraphApps | Select-Object DisplayName, AppId, @{n="TenantId";e={(Get-MgContext).TenantId}} |
        Export-Csv -Path ".\AADGraphDependencies.csv" -NoTypeInformation -Encoding UTF8
    Write-Output "Results exported to AADGraphDependencies.csv"

}
else{
    Write-Output "No Azure AD Graph dependencies found in this tenant."
}

# Look for potential - recent - calls in logs
$logs = Get-MgAuditLogSignIn -All -Filter "ResourceDisplayName eq 'Windows Azure Active Directory Graph'"

if ($logs) {
    Write-Output "Recent Azure AD Graph calls were found in the sign-in logs:"
    $logs | Select-Object UserDisplayName, AppDisplayName, ResourceDisplayName, CreatedDateTime | Format-Table -AutoSize
} 
else{
    Write-Output "No recent Azure AD Graph calls found in the sign-in logs."
}
